===================================================================================================================================
Basic malware analysis using various tools (CAPA malware analysis tool, VirusTotal malware analysis platforms)
===================================================================================================================================

------------------------------------------------
Malware sample (Harriet-ReverseShellTest.exe)
------------------------------------------------
> I used as a sample a reverse meterpreter shell (shellcode) packed with the shellcode loader "Harriet".
> Harriet is a shellcode loader that uses encryption and function/variable obfuscation to get around AV solutions.
  All of the modules use XOR encryption for strings and function obfuscation and AES encryption for payload execution. 
  Once the payload is compiled, the script uses SigThief to sign the binary with a Microsoft certificate.
  (https://github.com/assume-breach/Home-Grown-Red-Team/tree/main/Harriet)

------------------------------------------------
Malware analysis tools
------------------------------------------------
> CAPA (malware analysis tool - https://github.com/mandiant/capa)
  It detects capabilities in executable files and can be run against a PE, ELF, .NET module, shellcode file. 
> VirusTotal (on-line malware analysis platform - https://www.virustotal.com)
  It aggregates 70+ antivirus products and online scan engines.
> Metadefender Cloud (on-line malware analysis platform - https://metadefender.opswat.com)

------------------------------------------------
Malware analysis - Results
------------------------------------------------
> CAPA detected that the file is malicious and identified that it implements defense evasion techniques (encryption, ETW patching) 
  and code execution techniques (load-code/shellcode, Allocate Memory/Create Thread).

> VirusTotal reported the file as malicious and provided many information about our malware (which is rightfully identified as a C2 implant):
  + Report: https://www.virustotal.com/gui/file/0290ddb4f1e966d92b2b62a8916b2174e663f9ef2f4138082b5ecde4ce81e717
  + 36/65 security vendors flagged the file as malicious
  + 3 sandboxes flagged the file as malicious
  + Popular threat label: trojan.shellcode/loader
  + Threat categories: trojan
  + Family labels: shellcode | loader | marte


===================================================================================================================================
CAPA malware analysis tool - Detailed results
===================================================================================================================================

C:\Users\auditor\Documents\Tools\17-DFIR\capa-v7.0.1> capa.exe Harriet-ReverseShellTest.exe

┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ md5                    │ 9b041e7ddc7676463edcc8fd15a8076e                                                         │
│ sha1                   │ 40a8226eb42913c9b662850337709102b1a2ed70                                                 │
│ sha256                 │ 0290ddb4f1e966d92b2b62a8916b2174e663f9ef2f4138082b5ecde4ce81e717                         │
│ analysis               │ static                                                                                   │
│ os                     │ windows                                                                                  │
│ format                 │ pe                                                                                       │
│ arch                   │ amd64                                                                                    │
│ path                   │ C:/Users/auditor/Documents/Tools/17-DFIR/capa-v7.0.1/Harriet-ReverseShellTest.exe 	    │
┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ ATT&CK Tactic          │ ATT&CK Technique                                                                   │
┝━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ DEFENSE EVASION        │ Impair Defenses::Disable or Modify Tools T1562.001                                 │
│                        │ Obfuscated Files or Information T1027                                              │
├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
│ EXECUTION              │ Shared Modules T1129                                                               │
┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ MBC Objective               │ MBC Behavior                                                                  │
┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ CRYPTOGRAPHY                │ Cryptographic Hash [C0029]                                                    │
│                             │ Decrypt Data [C0031]                                                          │
│                             │ Encrypt Data [C0027]                                                          │
│                             │ Encrypt Data::AES [C0027.001]                                                 │
│                             │ Encryption Key [C0028]                                                        │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ DEFENSE EVASION             │ Disable or Evade Security Tools [F0004]                                       │
│                             │ Obfuscated Files or Information::Encryption-Standard Algorithm [E1027.m05]    │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ DISCOVERY                   │ Code Discovery::Enumerate PE Sections [B0046.001]                             │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ FILE SYSTEM                 │ Writes File [C0052]                                                           │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ MEMORY                      │ Allocate Memory [C0007]                                                       │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ PROCESS                     │ Create Thread [C0038]                                                         │
┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ Capability                                           │ Namespace                                            │
┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ patch Event Tracing for Windows function             │ anti-analysis/anti-av                                │
│ create new key via CryptAcquireContext               │ data-manipulation/encryption                         │
│ encrypt or decrypt via WinCrypt                      │ data-manipulation/encryption                         │
│ encrypt data using AES via WinAPI                    │ data-manipulation/encryption/aes                     │
│ hash data via WinCrypt                               │ data-manipulation/hashing                            │
│ initialize hashing via WinCrypt                      │ data-manipulation/hashing                            │
│ contain a thread local storage (.tls) section        │ executable/pe/section/tls                            │
│ write file on Windows                                │ host-interaction/file-system/write                   │
│ get thread local storage value                       │ host-interaction/process                             │
│ link function at runtime on Windows                  │ linking/runtime-linking                              │
│ enumerate PE sections (4 matches)                    │ load-code/pe                                         │
│ parse PE header (9 matches)                          │ load-code/pe                                         │
│ execute shellcode via indirect call                  │ load-code/shellcode                                  │
│ spawn thread to RWX shellcode                        │ load-code/shellcode                                  │
┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙


C:\Users\auditor\Documents\Tools\17-DFIR\capa-v7.0.1> capa.exe Harriet-ReverseShellTest.exe -v

md5                     9b041e7ddc7676463edcc8fd15a8076e
sha1                    40a8226eb42913c9b662850337709102b1a2ed70
sha256                  0290ddb4f1e966d92b2b62a8916b2174e663f9ef2f4138082b5ecde4ce81e717
path                    C:/Users/Tools/Documents/Tools-Pentest/17-DFIR/capa-v7.0.1/Harriet-ReverseShellTest.exe
timestamp               2024-02-13 02:40:47.377105
capa version            7.0.1
os                      windows
format                  pe
arch                    amd64
analysis                static
extractor               VivisectFeatureExtractor
base address            0x400000
rules                   C:/Users/Tools/AppData/Local/Temp/_MEI164402/rules
function count          70
library function count  0
total feature count     6130

patch Event Tracing for Windows function
namespace  anti-analysis/anti-av
scope      function
matches    0x40174C

create new key via CryptAcquireContext
namespace  data-manipulation/encryption
scope      function
matches    0x401540

encrypt or decrypt via WinCrypt
namespace  data-manipulation/encryption
scope      function
matches    0x401540

encrypt data using AES via WinAPI
namespace  data-manipulation/encryption/aes
scope      function
matches    0x401540

hash data via WinCrypt
namespace  data-manipulation/hashing
scope      function
matches    0x401540

initialize hashing via WinCrypt
namespace  data-manipulation/hashing
scope      function
matches    0x401540

contain a thread local storage (.tls) section
namespace  executable/pe/section/tls
scope      file

write file on Windows
namespace  host-interaction/file-system/write
scope      function
matches    0x401CB0

get thread local storage value
namespace  host-interaction/process
scope      function
matches    0x402340

allocate or change RWX memory (2 matches)
namespace  host-interaction/process/inject
scope      basic block
matches    0x40174C
           0x401E00

create thread
namespace  host-interaction/thread/create
scope      basic block
matches    0x401970

link function at runtime on Windows
namespace  linking/runtime-linking
scope      function
matches    0x40174C

enumerate PE sections (4 matches)
namespace  load-code/pe
scope      function
matches    0x4025E0
           0x4026D0
           0x402840
           0x4028D0

parse PE header (9 matches)
namespace  load-code/pe
scope      function
matches    0x401010
           0x4025B0
           0x402630
           0x4026D0
           0x402750
           0x402790
           0x402800
           0x402840
           0x4028D0

execute shellcode via indirect call
namespace  load-code/shellcode
scope      function
matches    0x40174C

spawn thread to RWX shellcode
namespace  load-code/shellcode
scope      function
matches    0x40174C

===================================================================================================================================
VirusTotal malware analysis platform - Detailed results
===================================================================================================================================

> VirusTotal report
  + Url: https://www.virustotal.com/gui/file/0290ddb4f1e966d92b2b62a8916b2174e663f9ef2f4138082b5ecde4ce81e717
  + 36/65 security vendors flagged the file as malicious
  + 3 sandboxes flagged the file as malicious
  + Popular threat label: trojan.shellcode/loader
  + Threat categories: trojan
  + Family labels: shellcode | loader | marte

---------------------------------------------------
Detection - Security vendors' analysis
---------------------------------------------------
ALYac			          - Generic.ShellCode.Loader.Marte.P.3DBE1F70
Arcabit			        - Generic.ShellCode.Loader.Marte.P.3DBE1F70
Avira (no cloud)	  - TR/Crypt.EPACK.Gen2
BitDefender		      - Generic.ShellCode.Loader.Marte.P.3DBE1F70
Bkav Pro		        - W64.AIDetectMalware
CrowdStrike Falcon	- Win/malicious_confidence_100% (D)
Cynet			          - Malicious (score: 100)
DeepInstinct		    - MALICIOUS
Elastic			        - Malicious (high Confidence)
Emsisoft		        - Generic.ShellCode.Loader.Marte.P.3DBE1F70 (B)
eScan			          - Generic.ShellCode.Loader.Marte.P.3DBE1F70
ESET-NOD32		      - A Variant Of Win64/Rozena.OJ
Fortinet		        - W64/Rozena.RG!tr
GData			          - Generic.ShellCode.Loader.Marte.P.3DBE1F70
Google			        - Detected
Ikarus			        - Trojan.Win64.Rozena
Malwarebytes		    - Backdoor.ShellCode
MAX			            - Malware (ai Score=83)
Microsoft		        - Trojan:Win64/CobaltStrike.BZ!MTB
Rising			        - Trojan.Rozena!8.6D (TFE:5:Pqt9WjHwKxV)
Sangfor Engine Zero	- Trojan.Win32.Save.a
SecureAge		        - Malicious
SentinelOne (Static ML)	- Static AI - Malicious PE
Sophos			        - ATK/Havoc-D
Symantec		        - ML.Attribute.HighConfidence
Trellix (FireEye)	  - Generic.mg.9b041e7ddc767646
VIPRE			          - Generic.ShellCode.Loader.Marte.P.3DBE1F70
WithSecure		      - Trojan.TR/Crypt.EPACK.Gen2
<SNIP>
Acronis (Static ML)	- Undetected
AhnLab-V3		        - Undetected
Alibaba			        - Undetected
Antiy-AVL		        - Undetected
Avast			          - Undetected
AVG			            - Undetected
Baidu			          - Undetected
BitDefenderTheta	  - Undetected
<SNIP>

---------------------------------------------------
Activity Summary
---------------------------------------------------

Dynamic Analysis Sandbox Detections
-----------------------------------
> The sandbox Zenbox flags this file as: MALWARE TROJAN
> The sandbox CAPE Sandbox flags this file as: MALWARE
> The sandbox Yomi Hunter flags this file as: MALWARE 

MITRE ATT&CK Tactics and Techniques
-----------------------------------
> Execution - TA0002
> Defense Evasion - TA0005
> Discovery - TA0007
> Command and Control - TA0011

Capabilities
------------
> Host-interaction
> load-code
> data-manipulation
> linking
> anti-analysis
> executable 

Network Communication - HTTP requests
-------------------------------------
> https://192.168.1.30:443/jrHfVIB6ujjTu9K5sCQzrwXoA0s-awO5m714LQwLFa2cQKXGqmngZjhREbKuaIHEU2bZXHpM7AGKycYYXLYgCpgxwcBTWFggJmlkQXmHQ00/

Process and service actions - Processes created
-----------------------------------------------
> %SAMPLEPATH%\Harriet-ReverseShellTest.exe
> C:\Users\user\Desktop\Harriet-ReverseShellTest.exe
> C:\Windows\System32\conhost.exe C:\Windows\system32\conhost.exe 0xffffffff -ForceV1
> C:\Windows\System32\wuapihost.exe

Processes tree
--------------
> 1584 - "C:\Users\<USER>\AppData\Local\Temp\Harriet-ReverseShellTest.exe"
> 2128 - a8065593597d0a8b6a8a17269359e7c3.exe
> 3076 - %WINDIR%\explorer.exe
  >  3156 - C:\Windows\System32\wuapihost.exe
  >  4076 - %SAMPLEPATH%\Harriet-ReverseShellTest.exe
> 624 - C:\Windows\System32\svchost.exe
> 7412 - C:\Users\user\Desktop\Harriet-ReverseShellTest.exe
  >  7420 - C:\Windows\System32\conhost.exe C:\Windows\system32\conhost.exe 0xffffffff -ForceV1 

<SNIP>
