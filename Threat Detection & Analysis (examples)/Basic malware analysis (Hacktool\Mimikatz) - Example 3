===================================================================================================================================
Basic malware analysis using various tools (CAPA malware analysis tool, VirusTotal malware analysis platform)
===================================================================================================================================

------------------------------------------------
Malware sample (PePacker-Mimi.exe)
------------------------------------------------
> I used as a sample the Windows hacking tool Mimikatz packed/obfuscated with "AtomPePacker".
  (https://github.com/gentilkiwi/mimikatz) 
> AtomPePacker is a PE packer with advanced defense evasion features such as:
  + direct syscalls 
  + NTDLL unhooking
  + no rwx section allocation
  + elzma compression algorithm
  + ...
 (https://github.com/ORCx41/AtomPePacker)

------------------------------------------------
Malware analysis tools
------------------------------------------------
> CAPA (malware analysis tool - https://github.com/mandiant/capa)
  It detects capabilities in executable files and can be run against a PE, ELF, .NET module, shellcode file. 
> VirusTotal (on-line malware analysis platform - https://www.virustotal.com)
  It aggregates 70+ antivirus products and online scan engines.

------------------------------------------------
Malware analysis - Results
------------------------------------------------
> CAPA detected that the file is malicious and identified that it implements defense evasion techniques (obfuscation, anti-analysis, encryption), 
  system information discovery (OS version checks) and code execution techniques (load-code/pe).

> VirusTotal reported the file as malicious and provided many information about our malware (which is rightfully identified as a version 
  of Mimikatz packed with the tool "atompepacker"):
  + https://www.virustotal.com/gui/file/dd7a9bd04ec6c78d33ec36fd2e259242e78cd71f5316b7c53d806ea12e0d9067
  + 51/71 security vendors flagged this file as malicious
  + 1 sandbox flagged the file as malicious
  + Popular threat label: trojan.lazy/mimikatz
  + Threat categories: trojan
  + Family labels: lazy | mimikatz | 
  + Several YARA rules from the 'THOR APT' Scanner were triggered/matched:
    > RULE: SUSP_PE_AtomPePacker_PP64Stub_Nov22_1
      DESCRIPTION: Detects files packed with AtomPePacker - file PP64Stub.exe
    > RULE: HKTL_ORCAx41_Nov22_1
      DESCRIPTION: Detects characteristics found in tools produced by ORCAx41 hack tool author
    > RULE: HKTL_Terra_Loader_Nov22_1
      DESCRIPTION: Detects TerraLoader PE loader


===================================================================================================================================
CAPA malware analysis tool - Detailed results
===================================================================================================================================

C:\Users\auditor\Documents\Tools\17-DFIR\capa-v7.0.1> capa.exe PePacker-Mimi.exe

┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ md5                    │ 76e2044323a6fadaa7c581c3f5d9a91c                                                   │
│ sha1                   │ 04a1b35ae331258c8820c3613a1d4c8905760c10                                           │
│ sha256                 │ dd7a9bd04ec6c78d33ec36fd2e259242e78cd71f5316b7c53d806ea12e0d9067                   │
│ analysis               │ static                                                                             │
│ os                     │ windows                                                                            │
│ format                 │ pe                                                                                 │
│ arch                   │ amd64                                                                              │
│ path                   │ C:/Users/auditor/Documents/Tools/17-DFIR/capa-v7.0.1/PePacker-Mimi.exe      │
┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ ATT&CK Tactic          │ ATT&CK Technique                                                                   │
┝━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ DEFENSE EVASION        │ Obfuscated Files or Information T1027                                              │
├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
│ DISCOVERY              │ System Information Discovery T1082                                                 │
├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
│ EXECUTION              │ Shared Modules T1129                                                               │
┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ MBC Objective               │ MBC Behavior                                                                  │
┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ DATA                        │ Checksum::CRC32 [C0032.001]                                                   │
│                             │ Encode Data::XOR [C0026.002]                                                  │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ DEFENSE EVASION             │ Obfuscated Files or Information::Encoding-Standard Algorithm [E1027.m02]      │
├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
│ DISCOVERY                   │ System Information Discovery [E1082]                                          │
┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
│ Capability                                           │ Namespace                                            │
┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
│ execute syscall instruction                          │ anti-analysis                                        │
│ hash data with CRC32                                 │ data-manipulation/checksum/crc32                     │
│ encode data using XOR (2 matches)                    │ data-manipulation/encoding/xor                       │
│ check OS version (2 matches)                         │ host-interaction/os/version                          │
│ access PEB ldr_data                                  │ linking/runtime-linking                              │
│ parse PE header (3 matches)                          │ load-code/pe                                         │
│ resolve function by parsing PE exports (3 matches)   │ load-code/pe                                         │
┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙


C:\Users\auditor\Documents\Tools\17-DFIR\capa-v7.0.1> capa.exe PePacker-Mimi.exe -v

md5                     76e2044323a6fadaa7c581c3f5d9a91c
sha1                    04a1b35ae331258c8820c3613a1d4c8905760c10
sha256                  dd7a9bd04ec6c78d33ec36fd2e259242e78cd71f5316b7c53d806ea12e0d9067
path                    C:/Users/auditor/Documents/Tools/17-DFIR/capa-v7.0.1/PePacker-Mimi.exe
timestamp               2024-02-13 02:49:20.164407
capa version            7.0.1
os                      windows
format                  pe
arch                    amd64
analysis                static
extractor               VivisectFeatureExtractor
base address            0x140000000
rules                   C:/Users/auditor/AppData/Local/Temp/_MEI165362/rules
function count          62
library function count  3
total feature count     10696

execute syscall instruction
namespace    anti-analysis
description  may be used to evade hooks or hinder analysis
scope        basic block
matches      0x1400056E1

hash data with CRC32
namespace  data-manipulation/checksum/crc32
scope      function
matches    0x1400041C0

encode data using XOR (2 matches)
namespace  data-manipulation/encoding/xor
scope      basic block
matches    0x1400041D0
           0x140004280

check OS version (2 matches)
namespace  host-interaction/os/version
scope      function
matches    0x140001BF0
           0x140004EC0

access PEB ldr_data
namespace  linking/runtime-linking
scope      basic block
matches    0x140001677

parse PE header (3 matches)
namespace  load-code/pe
scope      function
matches    0x1400019C0
           0x140001DC0
           0x140004EC0

resolve function by parsing PE exports (3 matches)
namespace  load-code/pe
scope      function
matches    0x140001730
           0x140001DC0
           0x140004EC0


===================================================================================================================================
VirusTotal malware analysis platform - Detailed results
===================================================================================================================================

> VirusTotal reported the file as malicious and provided many information about our malware (which is rightfully identified as a C2 implant):
  + https://www.virustotal.com/gui/file/dd7a9bd04ec6c78d33ec36fd2e259242e78cd71f5316b7c53d806ea12e0d9067
  + 51/71 security vendors flagged this file as malicious
  + 1 sandbox flagged the file as malicious
  + Popular threat label: trojan.lazy/mimikatz
  + Threat categories: trojan
  + Family labels: lazy | mimikatz | atompepacker
  + Several YARA rules from the 'THOR APT' Scanner were triggered/matched:
    > RULE: SUSP_PE_AtomPePacker_PP64Stub_Nov22_1
      RULE_SET: Livehunt - Suspicious271 Indicators 🏹
      DESCRIPTION: Detects files packed with AtomPePacker - file PP64Stub.exe
    > RULE: HKTL_ORCAx41_Nov22_1
      RULE_SET: Livehunt - Hacktools187 Indicators 🛠
      RULE_TYPE: VALHALLA rule feed only ⚡
      DESCRIPTION: Detects characteristics found in tools produced by ORCAx41 hack tool author
    > RULE: HKTL_Terra_Loader_Nov22_1
      RULE_SET: Livehunt - Hacktools187 Indicators 🛠
      RULE_TYPE: VALHALLA rule feed only ⚡
      DESCRIPTION: Detects TerraLoader PE loader

--------------------------------
Security vendors' analysis
--------------------------------
AhnLab-V3 - Trojan/Win.Generic.R531501
Alibaba - Trojan:Win64/TerraLoader.d9d7d8bb
ALYac - Gen:Variant.Lazy.254152
Antiy-AVL - Trojan[PSW]/Win32.Mimikatz
Arcabit - Trojan.Lazy.D3E0C8
Avast - Win64:HacktoolX-gen [Trj]
AVG - Win64:HacktoolX-gen [Trj]
Avira (no cloud) - HEUR/AGEN.1316272
BitDefender - Gen:Variant.Lazy.254152
Bkav Pro - W64.AIDetectMalware
ClamAV - Win.Packed.Lazy-9998088-0
CrowdStrike Falcon - Win/malicious_confidence_100% (W)
Cylance - Unsafe
Cynet - Malicious (score: 100)
DeepInstinct - MALICIOUS
Elastic - Malicious (high Confidence)
Emsisoft - Gen:Variant.Lazy.254152 (B)
eScan - Gen:Variant.Lazy.254152
ESET-NOD32 - A Variant Of Win64/GenKryptik.GBHB
Fortinet - W64/GenKryptik.GBHB!tr
GData - Gen:Variant.Lazy.254152
Google - Detected
Gridinsoft (no cloud) - Trojan.Heur!.02052023
Ikarus - Trojan.Win64.Krypt
Jiangmin - Trojan.PSW.Mimikatz.dsr
K7AntiVirus - Trojan ( 00599b981 )
K7GW - Trojan ( 00599b981 )
Kaspersky - HEUR:Trojan.Win64.AtomPePacker.a
Kingsoft - Win32.Troj.Unknown.a
Lionic - Trojan.Win32.Mimikatz.4!c
Malwarebytes - Crypt.Trojan.MSIL.DDS
MAX - Malware (ai Score=86)
McAfee - GenericRXAA-AA!76E2044323A6
Microsoft - Trojan:Win64/TerraLoader.A!MTB
Rising - Stealer.Mimikatz!8.1335D (C64:YzY0Oi3LZzN3ZI7F)
Sangfor Engine Zero - Trojan.Win64.Lazy.Vx5i
SecureAge - Malicious
SentinelOne (Static ML) - Static AI - Malicious PE
Skyhigh (SWG) - BehavesLike.Win64.Trojan.hc
Sophos - Mal/Generic-S
Symantec - ML.Attribute.HighConfidence
TEHTRIS - Generic.Malware
Tencent - Malware.Win32.Gencirc.10bd90d8
Trellix (FireEye) - Gen:Variant.Lazy.254152
TrendMicro - TROJ_GEN.R002C0DBD24
TrendMicro-HouseCall - TROJ_GEN.R002C0DBD24
VIPRE - Gen:Variant.Lazy.254152
VirIT - Trojan.Win64.Genus.BMZ
WithSecure - Heuristic.HEUR/AGEN.1316272
Zillya - Trojan.GenKryptik.Win64.8669
ZoneAlarm by Check Point - HEUR:Trojan.Win64.AtomPePacker.a
Acronis (Static ML) - Undetected
Baidu - Undetected
BitDefenderTheta - Undetected
<SNIP>


MITRE ATT&CK Tactics and Techniques
-----------------------------------
> Execution - TA0002
> Defense Evasion - TA0005
> Credential Access - TA0006
> Discovery - TA0007

Capabilities
------------
> linking
> data-manipulation 
> anti-analysis
> load-code
> host-interaction 

Processes tree
--------------
> 1716 - %SAMPLEPATH%\PePacker-Mimi.exe
> 2932 - %WINDIR%\explorer.exe
  + 448 - C:\Windows\System32\conhost.exe C:\Windows\system32\conhost.exe 0xffffffff -ForceV1
> 624 - C:\Windows\System32\svchost.exe
  + 732 - C:\Windows\System32\wuapihost.exe
> 924 - C:\Users\user\Desktop\PePacker-Mimi.exe

<SNIP>
