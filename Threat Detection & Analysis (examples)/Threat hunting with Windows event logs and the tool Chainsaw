==================================================================================================================================
Threat hunting with Windows event logs and the tool Chainsaw
==================================================================================================================================

> Chainsaw is a command-line tool that allow to rapidly search and hunt through Windows forensic artefacts.
> It provides a powerful ‘first-response’ capability to quickly identify threats within Windows forensic artefacts such as Event Logs and the MFT file. 
> It offers a generic and fast method of searching through event logs for keywords, and by identifying threats using built-in support for Sigma detection rules, and via custom Chainsaw detection rules.

GitHub link - https://github.com/WithSecureLabs/chainsaw/tree/master?tab=readme-ov-file

------------
Features
------------
> Hunt for threats using Sigma detection rules and custom Chainsaw detection rules
> Search and extract forensic artefacts by string matching, and regex patterns
> Create execution timelines by analysing Shimcache artefacts and enriching them with Amcache data
> Analyse the SRUM database and provide insights about it
> Dump the raw content of forensic artefacts (MFT, registry hives, ESE databases)
> Lightning fast, written in rust, wrapping the EVTX parser library by @OBenamram
> Clean and lightweight execution and output formats without unnecessary bloat
> Document tagging (detection logic matching) provided by the TAU Engine Library
> Output results in a variety of formats, such as ASCII table format, CSV format, and JSON format
> Can be run on MacOS, Linux and Windows

--------------------------
Note regarding SIGMA rules
--------------------------
We can add SIGMA rules in the folder "/sigma/rules/" to detect more potential threats.
For instance, below are 2 good sources for SIGMA rules: 
> https://github.com/SigmaHQ/sigma/tree/master/rules
> https://github.com/mdecrevoisier/SIGMA-detection-rules

--------------------------
Chainsaw Detection Rules
--------------------------
In addition to supporting sigma rules, Chainsaw also supports a custom rule format. In the repository you will find a rules directory that contains various Chainsaw rules that allows users to:
> Extract and parse Windows Defender, F-Secure, Sophos, and Kaspersky AV alerts
> Detect key event logs being cleared, or the event log service being stopped
> Users being created or added to sensitive user groups
> Remote Logins (Service, RDP, Network etc.) events. This helps hunters to identify sources of lateral movement
> Brute-force of local user accounts


==================================================================================================================================
PoC / Test - Threat Hunting using Chainsaw
==================================================================================================================================

C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe
Rapidly work with Forensic Artefacts

Usage: chainsaw.exe [OPTIONS] <COMMAND>

Commands:
  dump     Dump an artefact into a different format
  hunt     Hunt through artefacts using detection rules for threat detection
  lint     Lint provided rules to ensure that they load correctly
  search   Search through forensic artefacts for keywords
  analyse  Perform various analyses on artefacts
  help     Print this message or the help of the given subcommand(s)

Options:
      --no-banner                  Hide Chainsaw's banner
      --num-threads <NUM_THREADS>  Limit the thread number (default: num of CPUs)
  -h, --help                       Print help
  -V, --version                    Print version

Examples:

    Hunt with Sigma and Chainsaw Rules:
        ./chainsaw hunt evtx_attack_samples/ -s sigma/ --mapping mappings/sigma-event-logs-all.yml -r rules/

    Hunt with Sigma rules and output in JSON:
        ./chainsaw hunt evtx_attack_samples/ -s sigma/ --mapping mappings/sigma-event-logs-all.yml --json

    Search for the case-insensitive word 'mimikatz':
        ./chainsaw search mimikatz -i evtx_attack_samples/

    Search for Powershell Script Block Events (EventID 4014):
        ./chainsaw search -t 'Event.System.EventID: =4104' evtx_attack_samples/

------------------------------------------------------------------------------------------------------------------------------------------------------------------
Example 1 - Hunt through all Windows event logs of a Windows computer using SIGMA & Chainsaw rules to detect potential malicious activities that occurred in 2023
------------------------------------------------------------------------------------------------------------------------------------------------------------------

Step 1 - Extract the Windows event logs of the Windows machine that you want to audit (e.g. Windows 10 laptop) 
----------------------------------------------------------------------------------------------------------------

PS C:\temp> .\windows-log-collector-full-v3-EVTX.ps1

Directory: C:\temp
Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         2/18/2024   9:27 PM                wineventlog

PS C:\temp> ls .\wineventlog\

    Directory: C:\temp\wineventlog

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/18/2024   9:27 PM       12652544 Application.evtx
-a----         2/18/2024   9:27 PM        1118208 LocalSessionManager.evtx
-a----         2/18/2024   9:27 PM       15798272 Powershell_Operational.evtx
-a----         2/18/2024   9:27 PM       21041152 Security.evtx
-a----         2/18/2024   9:27 PM       21041152 System.evtx
-a----         2/18/2024   9:27 PM       10555392 TaskScheduler.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_Defender.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_PowerShell.evtx
-a----         2/18/2024   9:27 PM        1118208 WinRM.evtx


Step 2: Copy all the Windows event logs on your DFIR computer/VM
-----------------------------------------------------------------

PS C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw\Logs1> ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/18/2024   9:27 PM       12652544 Application.evtx
-a----         2/18/2024   9:27 PM        1118208 LocalSessionManager.evtx
-a----         2/18/2024   9:27 PM       15798272 Powershell_Operational.evtx
-a----         2/18/2024   9:27 PM       21041152 Security.evtx
-a----         2/18/2024   9:27 PM       21041152 System.evtx
-a----         2/18/2024   9:27 PM       10555392 TaskScheduler.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_Defender.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_PowerShell.evtx
-a----         2/18/2024   9:27 PM        1118208 WinRM.evtx


Step 3 - Run Chainsaw on your DFIR computer/VM
-----------------------------------------------

C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe hunt -r rules/ ./Logs1/ --mapping mappings/sigma-event-logs-all.yml --sigma ./sigma/rules/ --from "2023-01-01T00:00:00" --to "2023-12-31T00:00:00"

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: rules/, ./sigma/rules/
[!] Loaded 3032 detection rules (195 not loaded)
[+] Loading forensic artefacts from: ./Logs1/ (extensions: .evtx, .evt)
[+] Loaded 13 forensic artefacts (96.3 MB)
[+] Hunting: [========================================] 13/13 -
[+] 2163 Detections found on 1512 documents


[+] Group: Account Tampering
┌─────────────────────┬─────────────────────────────┬──────────┬───────────┬──────────────────────┬──────────────┬────────────────────────────────┬────────────────────────────────┐
│      timestamp      │         detections          │ Event ID │ Record ID │       Computer       │     User     │            User SID            │           Member SID           │
├─────────────────────┼─────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────┼────────────────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:04 │ + User Added to Global      │ 4728     │ 115759    │ Laptop01.lab.local   │ Aucun        │                                │ S-1-5-21-623615720-976303472-2 │
│                     │ Group                       │          │           │                      │              │                                │ 81948982-1005                  │
├─────────────────────┼─────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────┼────────────────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:04 │ + New User Created          │ 4720     │ 115760    │ Laptop01.lab.local   │ webadmin     │ S-1-5-21-623615720-976303472-2 │                                │
│                     │                             │          │           │                      │              │ 81948982-1005                  │                                │
├─────────────────────┼─────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────┼────────────────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:15 │ + User Added to Global      │ 4728     │ 115769    │ Laptop01.lab.local   │ Aucun        │                                │ S-1-5-21-623615720-976303472-2 │
│                     │ Group                       │          │           │                      │              │                                │ 81948982-1006                  │
├─────────────────────┼─────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────┼────────────────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:15 │ + New User Created          │ 4720     │ 115770    │ Laptop01.lab.local   │ webadmin     │ S-1-5-21-623615720-976303472-2 │                                │
│                     │                             │          │           │                      │              │ 81948982-1006                  │                                │
├─────────────────────┼─────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────┼────────────────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:15 │ + User Added to Local Group │ 4732     │ 115774    │ Laptop01.lab.local   │ Utilisateurs │                                │ S-1-5-21-623615720-976303472-2 │
│                     │                             │          │           │                      │              │                                │ 81948982-1006                  │
└─────────────────────┴─────────────────────────────┴──────────┴───────────┴──────────────────────┴──────────────┴────────────────────────────────┴────────────────────────────────┘

[+] Group: Antivirus
┌─────────────────────┬────────────────────┬──────────┬───────────┬──────────────────────┬────────────────────────────────┬──────────────────────────────────┬──────┬─────────────────────┬─────────────┐
│      timestamp      │     detections     │ Event ID │ Record ID │       Computer       │          Threat Name           │           Threat Path            │ SHA1 │        User         │ Threat Type │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
│ 2023-02-23 17:36:05 │ + Windows Defender │ 1116     │ 322       │ Laptop01.lab.local   │ Trojan:Win32/LsassDump.A       │ file:_C:\Temp\lsass_964\lsass_   │      │ LAB\user01          │             │
│                     │                    │          │           │                      │                                │ 964.dmp                          │      │                     │             │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
│ 2023-02-23 17:45:48 │ + Windows Defender │ 1116     │ 326       │ Laptop01.lab.local   │ Behavior:Win32/LsassDump.AE    │ behavior:_process: C:\Windows\   │      │                     │             │
│                     │                    │          │           │                      │                                │ System32\WindowsPowerShell\v1.   │      │                     │             │
│                     │                    │          │           │                      │                                │ 0\powershell.exe, pid:7784:854   │      │                     │             │
│                     │                    │          │           │                      │                                │ 35360086420; process:_pid:7784   │      │                     │             │
│                     │                    │          │           │                      │                                │ ,ProcessStart:1332164728625758   │      │                     │             │
│                     │                    │          │           │                      │                                │ 21                               │      │                     │             │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
│ 2023-03-12 03:21:48 │ + Windows Defender │ 1116     │ 592       │ Laptop01.lab.local   │ Behavior:Win32/Meterpreter.gen │ behavior:_process: C:\Temp\GoP   │      │                     │             │
│                     │                    │          │           │                      │ !D                             │ urple.exe, pid:17156:56844127    │      │                     │             │
│                     │                    │          │           │                      │                                │ 554067; process:_pid:17156,Pro   │      │                     │             │
│                     │                    │          │           │                      │                                │ cessStart:133230649079397908     │      │                     │             │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
│ 2023-09-18 19:32:42 │ + Windows Defender │ 1116     │ 2109      │ Laptop01.lab.local   │ Behavior:Win32/LsassDump.AE    │ behavior:_process: C:\Users\user │      │ AUTORITE NT\Système │             │
│                     │                    │          │           │                      │                                │ 01\Desktop\EDRSandblast.exe,     │      │                     │             │
│                     │                    │          │           │                      │                                │  pid:12392:85435360086420; fil   │      │                     │             │
│                     │                    │          │           │                      │                                │ e:_C:\Users\user01\Desktop\lsa   │      │                     │             │
│                     │                    │          │           │                      │                                │ ss                               │      │                     │             │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
│ 2023-09-18 19:40:13 │ + Windows Defender │ 1116     │ 2134      │ Laptop01.lab.local   │ VirTool:PowerShell/BypassAMSI. │ amsi:_\Device\HarddiskVolume3\   │      │ LAB\user01          │             │
│                     │                    │          │           │                      │ gen!A                          │ Windows\System32\WindowsPowerS   │      │                     │             │
│                     │                    │          │           │                      │                                │ hell\v1.0\powershell.exe         │      │                     │             │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
│ 2023-11-19 02:29:37 │ + Windows Defender │ 1117     │ 2561      │ Laptop01.lab.local   │ Trojan:Win64/TerraLoader.A!MTB │ file:_C:\Temp\Packed-PPLbade.e   │      │ LAB\user01          │             │
│                     │                    │          │           │                      │                                │ xe                               │      │                     │             │
├─────────────────────┼────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼──────────────────────────────────┼──────┼─────────────────────┼─────────────┤
<SNIP>


[+] Group: Lateral Movement
┌─────────────────────┬─────────────────┬──────────┬───────────┬──────────────────────┬────────┬────────────┬────────────────┐
│      timestamp      │   detections    │ Event ID │ Record ID │       Computer       │  User  │ Logon Type │   IP Address   │
├─────────────────────┼─────────────────┼──────────┼───────────┼──────────────────────┼────────┼────────────┼────────────────┤
│ 2023-09-27 15:46:06 │ + Network Logon │ 4624     │ 103938    │ Laptop01.lab.local   │ user01 │ 3          │ 192.168.25.124 │
├─────────────────────┼─────────────────┼──────────┼───────────┼──────────────────────┼────────┼────────────┼────────────────┤
│ 2023-09-27 15:58:25 │ + Network Logon │ 4624     │ 103951    │ Laptop01.lab.local   │ user01 │ 3          │ 192.168.25.124 │
├─────────────────────┼─────────────────┼──────────┼───────────┼──────────────────────┼────────┼────────────┼────────────────┤
<SNIP>

[+] Group: Login Attacks
┌─────────────────────┬───────────────────────┬───────┬──────────┬──────────────────┐
│      timestamp      │      detections       │ count │ Event ID │       User       │
├─────────────────────┼───────────────────────┼───────┼──────────┼──────────────────┤
│ 2023-09-27 15:28:02 │ + Account Brute Force │ 21    │ 4625     │ user01           │
├─────────────────────┼───────────────────────┼───────┼──────────┼──────────────────┤
│ 2023-09-27 15:45:25 │ + Account Brute Force │ 16    │ 4625     │ auditor.external │
├─────────────────────┼───────────────────────┼───────┼──────────┼──────────────────┤
│ 2023-09-27 15:59:03 │ + Account Brute Force │ 6     │ 4625     │ MTL-LTP-888$     │
└─────────────────────┴───────────────────────┴───────┴──────────┴──────────────────┘

[+] Group: RDP Events[0m
┌─────────────────────┬─────────────────────────────────┬──────────┬────────────────────────────────┬──────────────────────┬────────────────────────────────┐
│      timestamp      │           detections            │ Event ID │            Channel             │       Computer       │          Information           │
├─────────────────────┼─────────────────────────────────┼──────────┼────────────────────────────────┼──────────────────────┼────────────────────────────────┤
│ 2023-02-06 12:44:39 │ + RDS - Session logoff          │ 23       │ Microsoft-Windows-TerminalServ │ DESKTOP-N8FKQA5      │ SessionID: 2                   │
│                     │ succeeded                       │          │ ices-LocalSessionManager/Opera │                      │ User: DESKTOP-N8FKQA5\trs      │
│                     │                                 │          │ tional                         │                      │                                │
├─────────────────────┼─────────────────────────────────┼──────────┼────────────────────────────────┼──────────────────────┼────────────────────────────────┤
│ 2023-02-06 12:46:34 │ + RDS - Session logoff          │ 23       │ Microsoft-Windows-TerminalServ │ Laptop01.lab.local   │ SessionID: 1                   │
│                     │ succeeded                       │          │ ices-LocalSessionManager/Opera │                      │ User: LAB\administrator        │
│                     │                                 │          │ tional                         │                      │                                │
├─────────────────────┼─────────────────────────────────┼──────────┼────────────────────────────────┼──────────────────────┼────────────────────────────────┤
│ 2023-02-08 15:52:38 │ + RDS - Session logon succeeded │ 21       │ Microsoft-Windows-TerminalServ │ Laptop01.lab.local   │ Address: 192.168.13.154        │
│                     │                                 │          │ ices-LocalSessionManager/Opera │                      │ SessionID: 3                   │
│                     │                                 │          │ tional                         │                      │ User: LAB\user01               │
├─────────────────────┼─────────────────────────────────┼──────────┼────────────────────────────────┼──────────────────────┼────────────────────────────────┤
<SNIP>

[+] Group: Service Installation
┌─────────────────────┬────────────────────────────┬──────────┬───────────┬──────────────────────┬────────────────────────────────┬────────────────────────────────┬──────────────────────┬────────────────────────┬─────────────────┐
│      timestamp      │         detections         │ Event ID │ Record ID │       Computer       │          Service Name          │       Service File Name        │     Service Type     │   Service Start Type   │ Service Account │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-22 10:48:17 │ + Suspicious Paths Service │ 7045     │ 17598     │ Laptop01.lab.local   │ VMware hcmon                   │ \SystemRoot\system32\DRIVERS\h │ pilote en mode noyau │ Démarrage automatique  │                 │
│                     │ Installation               │          │           │                      │                                │ cmon.sys                       │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-22 10:48:23 │ + Suspicious Paths Service │ 7045     │ 17600     │ Laptop01.lab.local   │ VMware Bridge Protocol         │ \SystemRoot\system32\DRIVERS\v │ pilote en mode noyau │ Démarrage automatique  │                 │
│                     │ Installation               │          │           │                      │                                │ mnetbridge.sys                 │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-22 10:48:24 │ + Suspicious Paths Service │ 7045     │ 17602     │ Laptop01.lab.local   │ VMware Virtual Ethernet Userif │ \SystemRoot\system32\DRIVERS\v │ pilote en mode noyau │ Démarrage automatique  │                 │
│                     │ Installation               │          │           │                      │  for VMnet                     │ mnetuserif.sys                 │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-22 10:48:32 │ + Suspicious Paths Service │ 7045     │ 17606     │ Laptop01.lab.local   │ VMware Virtual Ethernet Adapte │ \SystemRoot\system32\DRIVERS\v │ pilote en mode noyau │ Démarrage à la demande │                 │
│                     │ Installation               │          │           │                      │ r Driver                       │ mnetadapter.sys                │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-22 10:48:37 │ + Suspicious Paths Service │ 7045     │ 17612     │ Laptop01.lab.local   │ VMware vmx86                   │ \SystemRoot\system32\DRIVERS\v │ pilote en mode noyau │ Démarrage automatique  │                 │
│                     │ Installation               │          │           │                      │                                │ mx86.sys                       │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-22 10:48:38 │ + Suspicious Paths Service │ 7045     │ 17617     │ Laptop01.lab.local   │ vSockets Virtual Machine Commu │ \SystemRoot\system32\DRIVERS\v │ pilote en mode noyau │ Démarrage du système   │                 │
│                     │ Installation               │          │           │                      │ nication Interface Sockets dri │ sock.sys                       │                      │                        │                 │
│                     │                            │          │           │                      │ ver                            │                                │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-03-28 09:58:56 │ + Suspicious Paths Service │ 7045     │ 18881     │ Laptop01.lab.local   │ VMware USB Client Driver       │ \SystemRoot\System32\drivers\v │ pilote en mode noyau │ Démarrage à la demande │                 │
│                     │ Installation               │          │           │                      │                                │ musb.sys                       │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-09-12 21:24:21 │ + Suspicious Paths Service │ 7045     │ 47957     │ Laptop01.lab.local   │ VirtualBox USB                 │ \SystemRoot\System32\Drivers\V │ pilote en mode noyau │ Démarrage à la demande │                 │
│                     │ Installation               │          │           │                      │                                │ BoxUSB.sys                     │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-09-18 19:28:11 │ + Suspicious Paths Service │ 7045     │ 48420     │ Laptop01.lab.local   │ aMI6HtmE                       │ C:\Users\user01\Desktop\RTCore │ pilote en mode noyau │ Démarrage automatique  │                 │
│                     │ Installation               │          │           │                      │                                │ 64.sys                         │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-09-21 11:27:12 │ + Suspicious Paths Service │ 7045     │ 49161     │ Laptop01.lab.local   │ ACX HD Audio Driver            │ \SystemRoot\System32\drivers\A │ pilote en mode noyau │ Démarrage à la demande │                 │
│                     │ Installation               │          │           │                      │                                │ cxHdAudio.sys                  │                      │                        │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼──────────────────────┼────────────────────────┼─────────────────┤
│ 2023-11-19 02:28:41 │ + Suspicious Paths Service │ 7045     │ 53127     │ Laptop01.lab.local   │ PPLBlade                       │ C:\Temp\PPLBLADE.SYS           │ pilote en mode noyau │ Démarrage à la demande │                 │
│                     │ Installation               │          │           │                      │                                │                                │                      │                        │                 │
└─────────────────────┴────────────────────────────┴──────────┴───────────┴──────────────────────┴────────────────────────────────┴────────────────────────────────┴──────────────────────┴────────────────────────┴─────────────────┘

[+] Group: Sigma
┌─────────────────────┬───────────────────────────┬───────┬────────────────────────────────┬──────────┬───────────┬──────────────────────┬────────────────────────────────┐
│      timestamp      │        detections         │ count │     Event.System.Provider      │ Event ID │ Record ID │       Computer       │           Event Data           │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-03-21 17:31:45 │ + WMI registration        │ 1     │ Microsoft-Windows-Kernel-Boot  │ 20       │ 17264     │ Laptop01.lab.local   │ BootStatusPolicy: 2            │
│                     │                           │       │                                │          │           │                      │ LastBootGood: true             │
│                     │                           │       │                                │          │           │                      │ LastBootId: 26                 │
│                     │                           │       │                                │          │           │                      │ LastShutdownGood: false        │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-03-21 17:31:45 │ + WMI registration        │ 1     │ Microsoft-Windows-Kernel-Gener │ 20       │ 17269     │ Laptop01.lab.local   │ CountNew: 0                    │
│                     │                           │       │ al                             │          │           │                      │ CountOld: 0                    │
│                     │                           │       │                                │          │           │                      │ EnabledNew: true               │
│                     │                           │       │                                │          │           │                      │ UpdateReason: 0                │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-03-21 17:42:14 │ + WMI registration        │ 1     │ Microsoft-Windows-WindowsUpdat │ 19       │ 17367     │ Laptop01.lab.local   │ serviceGuid: 9482F4B4-E343-43B │
│                     │                           │       │ eClient                        │          │           │                      │ 6-B170-9A65BC822C77            │
│                     │                           │       │                                │          │           │                      │ updateGuid: B2E582F3-8157-43C8 │
│                     │                           │       │                                │          │           │                      │ -A957-B403AE3027BF             │
│                     │                           │       │                                │          │           │                      │ updateRevisionNumber: 200      │
│                     │                           │       │                                │          │           │                      │ updateTitle: Mise à jour intel │
│                     │                           │       │                                │          │           │                      │ ligente de la sécurité pour Mi │
│                     │                           │       │                                │          │           │                      │ crosoft Defender Antivirus - K │
│                     │                           │       │                                │          │           │                      │ B2267602 (version 1.385.672.0) │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-03-22 09:56:22 │ + WMI registration        │ 1     │ Microsoft-Windows-WindowsUpdat │ 19       │ 17551     │ Laptop01.lab.local   │ serviceGuid: 9482F4B4-E343-43B │
│                     │                           │       │ eClient                        │          │           │                      │ 6-B170-9A65BC822C77            │
│                     │                           │       │                                │          │           │                      │ updateGuid: 20C9F2AD-3D88-4966 │
│                     │                           │       │                                │          │           │                      │ -945E-B7F6EF49E06C             │
│                     │                           │       │                                │          │           │                      │ updateRevisionNumber: 200      │
│                     │                           │       │                                │          │           │                      │ updateTitle: Security Intellig │
│                     │                           │       │                                │          │           │                      │ ence Update for Microsoft Defe │
│                     │                           │       │                                │          │           │                      │ nder Antivirus - KB2267602 (Ve │
│                     │                           │       │                                │          │           │                      │ rsion 1.385.757.0)             │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-03-22 11:02:09 │ + WMI registration        │ 1     │ Microsoft-Windows-WindowsUpdat │ 19       │ 17632     │ Laptop01.lab.local   │ serviceGuid: 855E8A7C-ECB4-4CA │
│                     │                           │       │ eClient                        │          │           │                      │ 3-B045-1DFA50104289            │
│                     │                           │       │                                │          │           │                      │ updateGuid: 99863FB8-3F8E-4F0C │
│                     │                           │       │                                │          │           │                      │ -8C0A-4D22BD9E9CDB             │
│                     │                           │       │                                │          │           │                      │ updateRevisionNumber: 1        │
│                     │                           │       │                                │          │           │                      │ updateTitle: 9PJPW5LDXLZ5-Pyth │
│                     │                           │       │                                │          │           │                      │ onSoftwareFoundation.Python.3. │
│                     │                           │       │                                │          │           │                      │ 10                             │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
<SNIP>
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────────────────────────┤
│ 2023-04-04 13:39:06 │ + Windows Defender Real-time │ 1     │ Microsoft-Windows-Windows Defe │ 5001     │ 1079      │ Laptop01.lab.local   │ Product Name: Antivirus Micros   │
│                     │ Protection Disabled          │       │ nder                           │          │           │                      │ oft Defender                     │
│                     │                              │       │                                │          │           │                      │ Product Version: 4.18.2302.7     │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼──────────────────────────────────┤
<SNIP>
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-18 20:39:46 │ + VSSAudit Security Event │ 1     │ Microsoft-Windows-Security-Aud │ 4904     │ 106707    │ Laptop01.lab.local   │ AuditSourceName: VSSAudit      │
│                     │ Source Registration       │       │ iting                          │          │           │                      │ EventSourceId: '0x1255c6b'     │
│                     │                           │       │                                │          │           │                      │ ProcessId: '0x38e8'            │
│                     │                           │       │                                │          │           │                      │ ProcessName: C:\Windows\System │
│                     │                           │       │                                │          │           │                      │ 32\VSSVC.exe                   │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x3e7'        │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: Laptop01$     │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-18       │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-18 20:39:46 │ + VSSAudit Security Event │ 1     │ Microsoft-Windows-Security-Aud │ 4905     │ 106708    │ Laptop01.lab.local   │ AuditSourceName: VSSAudit      │
│                     │ Source Registration       │       │ iting                          │          │           │                      │ EventSourceId: '0x1255c6b'     │
│                     │                           │       │                                │          │           │                      │ ProcessId: '0x38e8'            │
│                     │                           │       │                                │          │           │                      │ ProcessName: C:\Windows\System │
│                     │                           │       │                                │          │           │                      │ 32\VSSVC.exe                   │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x3e7'        │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: Laptop01$     │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-18       │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
<SNIP>
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:04:57 │ + User Logoff Event       │ 1     │ Microsoft-Windows-Security-Aud │ 4634     │ 115751    │ Laptop01.lab.local   │ LogonType: 2                   │
│                     │                           │       │ iting                          │          │           │                      │ TargetDomainName: LAB          │
│                     │                           │       │                                │          │           │                      │ TargetLogonId: '0xa278d9'      │
│                     │                           │       │                                │          │           │                      │ TargetUserName: user01         │
│                     │                           │       │                                │          │           │                      │ TargetUserSid: S-1-5-21-666114 │
│                     │                           │       │                                │          │           │                      │ 207-261065646-224150901-1121   │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:04 │ + A Member Was Added to   │ 1     │ Microsoft-Windows-Security-Aud │ 4728     │ 115759    │ Laptop01.lab.local   │ MemberName: '-'                │
│                     │ a Security-Enabled Global │       │ iting                          │          │           │                      │ MemberSid: S-1-5-21-623615720- │
│                     │ Group                     │       │                                │          │           │                      │ 976303472-281948982-1005       │
│                     │                           │       │                                │          │           │                      │ PrivilegeList: '-'             │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x32fe8e'     │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: user01        │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-21-66611 │
│                     │                           │       │                                │          │           │                      │ 4207-261065646-224150901-1121  │
│                     │                           │       │                                │          │           │                      │ TargetDomainName: Laptop01     │
│                     │                           │       │                                │          │           │                      │ TargetSid: S-1-5-21-623615720- │
│                     │                           │       │                                │          │           │                      │ 976303472-281948982-513        │
│                     │                           │       │                                │          │           │                      │ TargetUserName: Aucun          │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:04 │ + Local User Creation     │ 1     │ Microsoft-Windows-Security-Aud │ 4720     │ 115760    │ Laptop01.lab.local   │ AccountExpires: '%%1794'       │
│                     │                           │       │ iting                          │          │           │                      │ AllowedToDelegateTo: '-'       │
│                     │                           │       │                                │          │           │                      │ DisplayName: '%%1793'          │
│                     │                           │       │                                │          │           │                      │ HomeDirectory: '%%1793'        │
│                     │                           │       │                                │          │           │                      │ HomePath: '%%1793'             │
│                     │                           │       │                                │          │           │                      │ LogonHours: '%%1797'           │
│                     │                           │       │                                │          │           │                      │ NewUacValue: '0x15'            │
│                     │                           │       │                                │          │           │                      │ OldUacValue: '0x0'             │
│                     │                           │       │                                │          │           │                      │ PasswordLastSet: '%%1794'      │
│                     │                           │       │                                │          │           │                      │ PrimaryGroupId: '513'          │
│                     │                           │       │                                │          │           │                      │ PrivilegeList: '-'             │
│                     │                           │       │                                │          │           │                      │ ProfilePath: '%%1793'          │
│                     │                           │       │                                │          │           │                      │ SamAccountName: webadmin       │
│                     │                           │       │                                │          │           │                      │ ScriptPath: '%%1793'           │
│                     │                           │       │                                │          │           │                      │ SidHistory: '-'                │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x32fe8e'     │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: user01        │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-21-66611 │
│                     │                           │       │                                │          │           │                      │ 4207-261065646-224150901-1121  │
│                     │                           │       │                                │          │           │                      │ TargetDomainName: Laptop01     │
│                     │                           │       │                                │          │           │                      │ TargetSid: S-1-5-21-623615720- │
│                     │                           │       │                                │          │           │                      │ 976303472-281948982-1005       │
│                     │                           │       │                                │          │           │                      │ TargetUserName: webadmin       │
│                     │                           │       │                                │          │           │                      │ UserAccountControl: "\r\n\t\t% │
│                     │                           │       │                                │          │           │                      │ %2080\r\n\t\t%%2082\r\n\t\t%%2 │
│                     │                           │       │                                │          │           │                      │ 084"                           │
│                     │                           │       │                                │          │           │                      │ UserParameters: '%%1793'       │
│                     │                           │       │                                │          │           │                      │ UserPrincipalName: '-'         │
│                     │                           │       │                                │          │           │                      │ UserWorkstations: '%%1793'     │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:04 │ + A Member Was Removed    │ 1     │ Microsoft-Windows-Security-Aud │ 4729     │ 115761    │ Laptop01.lab.local   │ MemberName: '-'                │
│                     │ From a Security-Enabled   │       │ iting                          │          │           │                      │ MemberSid: S-1-5-21-623615720- │
│                     │ Global Group              │       │                                │          │           │                      │ 976303472-281948982-1005       │
│                     │                           │       │                                │          │           │                      │ PrivilegeList: '-'             │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x32fe8e'     │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: user01        │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-21-66611 │
│                     │                           │       │                                │          │           │                      │ 4207-261065646-224150901-1121  │
│                     │                           │       │                                │          │           │                      │ TargetDomainName: Laptop01     │
│                     │                           │       │                                │          │           │                      │ TargetSid: S-1-5-21-623615720- │
│                     │                           │       │                                │          │           │                      │ 976303472-281948982-513        │
│                     │                           │       │                                │          │           │                      │ TargetUserName: Aucun          │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:15 │ + A Member Was Added to   │ 1     │ Microsoft-Windows-Security-Aud │ 4728     │ 115769    │ Laptop01.lab.local   │ MemberName: '-'                │
│                     │ a Security-Enabled Global │       │ iting                          │          │           │                      │ MemberSid: S-1-5-21-623615720- │
│                     │ Group                     │       │                                │          │           │                      │ 976303472-281948982-1006       │
│                     │                           │       │                                │          │           │                      │ PrivilegeList: '-'             │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x32fe8e'     │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: user01        │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-21-66611 │
│                     │                           │       │                                │          │           │                      │ 4207-261065646-224150901-1121  │
│                     │                           │       │                                │          │           │                      │ TargetDomainName: Laptop01     │
│                     │                           │       │                                │          │           │                      │ TargetSid: S-1-5-21-623615720- │
│                     │                           │       │                                │          │           │                      │ 976303472-281948982-513        │
│                     │                           │       │                                │          │           │                      │ TargetUserName: Aucun          │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2023-11-19 17:09:15 │ + Local User Creation     │ 1     │ Microsoft-Windows-Security-Aud │ 4720     │ 115770    │ Laptop01.lab.local   │ AccountExpires: '%%1794'       │
│                     │                           │       │ iting                          │          │           │                      │ AllowedToDelegateTo: '-'       │
│                     │                           │       │                                │          │           │                      │ DisplayName: '%%1793'          │
│                     │                           │       │                                │          │           │                      │ HomeDirectory: '%%1793'        │
│                     │                           │       │                                │          │           │                      │ HomePath: '%%1793'             │
│                     │                           │       │                                │          │           │                      │ LogonHours: '%%1797'           │
│                     │                           │       │                                │          │           │                      │ NewUacValue: '0x15'            │
│                     │                           │       │                                │          │           │                      │ OldUacValue: '0x0'             │
│                     │                           │       │                                │          │           │                      │ PasswordLastSet: '%%1794'      │
│                     │                           │       │                                │          │           │                      │ PrimaryGroupId: '513'          │
│                     │                           │       │                                │          │           │                      │ PrivilegeList: '-'             │
│                     │                           │       │                                │          │           │                      │ ProfilePath: '%%1793'          │
│                     │                           │       │                                │          │           │                      │ SamAccountName: webadmin       │
│                     │                           │       │                                │          │           │                      │ ScriptPath: '%%1793'           │
│                     │                           │       │                                │          │           │                      │ SidHistory: '-'                │
│                     │                           │       │                                │          │           │                      │ SubjectDomainName: LAB         │
│                     │                           │       │                                │          │           │                      │ SubjectLogonId: '0x32fe8e'     │
│                     │                           │       │                                │          │           │                      │ SubjectUserName: user01        │
│                     │                           │       │                                │          │           │                      │ SubjectUserSid: S-1-5-21-66611 │
│                     │                           │       │                                │          │           │                      │ 4207-261065646-224150901-1121  │
│                     │                           │       │                                │          │           │                      │ TargetDomainName: Laptop01     │
│                     │                           │       │                                │          │           │                      │ TargetSid: S-1-5-21-623615720- │
│                     │                           │       │                                │          │           │                      │ 976303472-281948982-1006       │
│                     │                           │       │                                │          │           │                      │ TargetUserName: webadmin       │
│                     │                           │       │                                │          │           │                      │ UserAccountControl: "\r\n\t\t% │
│                     │                           │       │                                │          │           │                      │ %2080\r\n\t\t%%2082\r\n\t\t%%2 │
│                     │                           │       │                                │          │           │                      │ 084"                           │
│                     │                           │       │                                │          │           │                      │ UserParameters: '%%1793'       │
│                     │                           │       │                                │          │           │                      │ UserPrincipalName: '-'         │
│                     │                           │       │                                │          │           │                      │ UserWorkstations: '%%1793'     │
├─────────────────────┼───────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
<SNIP>


------------------------------------------------------------------------------------------------------------------------------------------------------------------
Example 2 - Hunt through all Windows event logs of a Windows computer using SIGMA & Chainsaw rules to detect potential malicious activities that occurred in 2024
            and output the results in JSON format and in CSV format
------------------------------------------------------------------------------------------------------------------------------------------------------------------

Step 1 - Extract the Windows event logs of the Windows machine that you want to audit (e.g. Windows 10 laptop) 
----------------------------------------------------------------------------------------------------------------

PS C:\temp> .\windows-log-collector-full-v3-EVTX.ps1

Directory: C:\temp
Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         2/18/2024   9:27 PM                wineventlog

PS C:\temp> ls .\wineventlog\

    Directory: C:\temp\wineventlog

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/18/2024   9:27 PM       12652544 Application.evtx
-a----         2/18/2024   9:27 PM        1118208 LocalSessionManager.evtx
-a----         2/18/2024   9:27 PM       15798272 Powershell_Operational.evtx
-a----         2/18/2024   9:27 PM       21041152 Security.evtx
-a----         2/18/2024   9:27 PM       21041152 System.evtx
-a----         2/18/2024   9:27 PM       10555392 TaskScheduler.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_Defender.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_PowerShell.evtx
-a----         2/18/2024   9:27 PM        1118208 WinRM.evtx


Step 2: Copy all the Windows event logs on your DFIR computer/VM
-----------------------------------------------------------------

PS C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw\Logs1> ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/18/2024   9:27 PM       12652544 Application.evtx
-a----         2/18/2024   9:27 PM        1118208 LocalSessionManager.evtx
-a----         2/18/2024   9:27 PM       15798272 Powershell_Operational.evtx
-a----         2/18/2024   9:27 PM       21041152 Security.evtx
-a----         2/18/2024   9:27 PM       21041152 System.evtx
-a----         2/18/2024   9:27 PM       10555392 TaskScheduler.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_Defender.evtx
-a----         2/18/2024   9:27 PM        4263936 Windows_PowerShell.evtx
-a----         2/18/2024   9:27 PM        1118208 WinRM.evtx


Step 3 - Run Chainsaw on your DFIR computer/VM
-----------------------------------------------

C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe hunt -r rules/ ./logs1/ --mapping mappings/sigma-event-logs-all.yml --sigma ./sigma/rules/ --from "2024-01-01T00:00:00" --to "2024-12-31T00:00:00" --json > Chainsaw-Threat-Hunting-Results-All.json

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: rules/, ./sigma/rules/
[!] Loaded 3032 detection rules (195 not loaded)
[+] Loading forensic artefacts from: ./logs1/ (extensions: .evtx, .evt)
[+] Loaded 13 forensic artefacts (96.3 MB)
[+] Hunting: [========================================] 13/13 -
[+] 1187 Detections found on 1003 documents


C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe hunt -r rules/ ./logs1/ --mapping mappings/sigma-event-logs-all.yml --sigma ./sigma/rules/ --from "2024-01-01T00:00:00" --to "2024-12-31T00:00:00" --csv --output C:\temp\Chainsaw\

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: rules/, ./sigma/rules/
[!] Loaded 3032 detection rules (195 not loaded)
[+] Loading forensic artefacts from: ./logs1/ (extensions: .evtx, .evt)
[+] Loaded 13 forensic artefacts (96.3 MB)
[+] Hunting: [========================================] 13/13 -                                                                                                             
[+] Created antivirus.csv
[+] Created login_attacks.csv
[+] Created powershell_script.csv
[+] Created rdp_events.csv
[+] Created service_installation.csv
[+] Created sigma.csv

[+] 1187 Detections found on 1003 documents


------------------------------------------------------------------------------------------------------------------------------------------------------------------
Example 3 - Hunt through all Windows event logs of a Windows computer using SIGMA & Chainsaw rules to detect potential malicious activities that occurred in 2024
            filtering by criticity level (Critical/High/Medium)
------------------------------------------------------------------------------------------------------------------------------------------------------------------

Step 1 - Extract the Windows event logs of the Windows machine that you want to audit (e.g. Win Server 2022) and then copy the log files on your DFIR computer/VM
------------------------------------------------------------------------------------------------------------------------------------------------------------------

PS C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw\logs> ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/15/2024   7:23 PM        1118208 Application.evtx
-a----         2/15/2024   7:22 PM       21041152 Security.evtx
-a----         2/15/2024   7:23 PM          69632 Setup.evtx
-a----         2/15/2024   7:22 PM        5312512 System.evtx


Step 2 - Run Chainsaw on your DFIR computer/VM
-----------------------------------------------

C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe hunt -r rules/ ./Logs/ --mapping mappings/sigma-event-logs-all.yml --sigma ./sigma/rules/ --level critical --from "2024-01-01T00:00:00" --to "2024-12-31T00:00:00" > Test-5.txt

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: rules/, ./sigma/rules/
[!] Loaded 99 detection rules (195 not loaded)
[+] Loading forensic artefacts from: ./Logs/ (extensions: .evt, .evtx)
[+] Loaded 4 forensic artefacts (27.5 MB)
[+] Hunting: [========================================] 4/4 -
[+] 64 Detections found on 64 documents

[+] Group: rdp_attacks
┌─────────────────────┬─────────────┬──────────┬──────────────────────┬─────────────┬──────────┬──────────┬────────────┬───────────┬────────┐
│      timestamp      │ detections  │ event id │       computer       │ ip address  │ username │ provider │ logon type │ record id │ domain │
├─────────────────────┼─────────────┼──────────┼──────────────────────┼─────────────┼──────────┼──────────┼────────────┼───────────┼────────┤
│ 2024-02-06 15:36:34 │ + RDP logon │ 4624     │ WinSrv-2022.lab      │ 10.10.10.30 │ su.adm   │          │ 10         │ 34801     │        │
├─────────────────────┼─────────────┼──────────┼──────────────────────┼─────────────┼──────────┼──────────┼────────────┼───────────┼────────┤
│ 2024-02-06 15:36:34 │ + RDP logon │ 4624     │ WinSrv-2022.lab      │ 10.10.10.30 │ su.adm   │          │ 10         │ 34802     │        │
├─────────────────────┼─────────────┼──────────┼──────────────────────┼─────────────┼──────────┼──────────┼────────────┼───────────┼────────┤
│ 2024-02-08 15:41:43 │ + RDP logon │ 4624     │ WinSrv-2022.lab      │ 10.10.10.10 │ jf.adm   │          │ 10         │ 39437     │        │
├─────────────────────┼─────────────┼──────────┼──────────────────────┼─────────────┼──────────┼──────────┼────────────┼───────────┼────────┤
│ 2024-02-08 15:41:43 │ + RDP logon │ 4624     │ WinSrv-2022.lab      │ 10.10.10.10 │ jf.adm   │          │ 10         │ 39438     │        │
├─────────────────────┼─────────────┼──────────┼──────────────────────┼─────────────┼──────────┼──────────┼────────────┼───────────┼────────┤
<SNIP>


C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe hunt -r rules/ ./Logs/ --mapping mappings/sigma-event-logs-all.yml --sigma ./sigma/rules/ --level high --from "2024-01-01T00:00:00" --to "2024-12-31T00:00:00"

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: rules/, ./sigma/rules/
[!] Loaded 1413 detection rules (195 not loaded)
[+] Loading forensic artefacts from: ./Logs/ (extensions: .evt, .evtx)
[+] Loaded 4 forensic artefacts (27.5 MB)
[+] Hunting: [========================================] 4/4 -
[+] 68 Detections found on 64 documents

[+] Group: Log Tampering
┌─────────────────────┬───────────────────────┬──────────┬───────────┬──────────────┬───────────────┐
│      timestamp      │      detections       │ Event ID │ Record ID │   Computer   │     User      │
├─────────────────────┼───────────────────────┼──────────┼───────────┼──────────────┼───────────────┤
│ 2024-01-15 16:19:16 │ + System Logs Cleared │ 104      │ 2212      │ Win-Srv-2022 │ Administrator │
├─────────────────────┼───────────────────────┼──────────┼───────────┼──────────────┼───────────────┤
│ 2024-01-15 16:19:16 │ + System Logs Cleared │ 104      │ 2213      │ Win-Srv-2022 │ Administrator │
├─────────────────────┼───────────────────────┼──────────┼───────────┼──────────────┼───────────────┤
│ 2024-01-15 16:19:16 │ + System Logs Cleared │ 104      │ 2214      │ Win-Srv-2022 │ Administrator │
├─────────────────────┼───────────────────────┼──────────┼───────────┼──────────────┼───────────────┤
│ 2024-01-15 16:20:25 │ + System Logs Cleared │ 104      │ 2298      │ Win-Srv-2022 │ Administrator │
└─────────────────────┴───────────────────────┴──────────┴───────────┴──────────────┴───────────────┘

[+] Group: Sigma
┌─────────────────────┬──────────────────────────────┬───────┬────────────────────────────────┬──────────┬───────────┬──────────────────────┬────────────────────────────────┐
│      timestamp      │          detections          │ count │     Event.System.Provider      │ Event ID │ Record ID │       Computer       │           Event Data           │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:19:16 │ + Event log cleared (native) │ 1     │ Microsoft-Windows-Eventlog     │ 104      │ 2212      │ Win-Srv-2022         │                                │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:19:16 │ + Event log cleared (native) │ 1     │ Microsoft-Windows-Eventlog     │ 104      │ 2213      │ Win-Srv-2022         │                                │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:19:16 │ + Event log cleared (native) │ 1     │ Microsoft-Windows-Eventlog     │ 104      │ 2214      │ Win-Srv-2022         │                                │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:20:25 │ + Event log cleared (native) │ 1     │ Microsoft-Windows-Eventlog     │ 104      │ 2298      │ Win-Srv-2022         │                                │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:20:46 │ + WMI registration           │ 1     │ Microsoft-Windows-Kernel-Boot  │ 20       │ 2369      │ WIN-T131EJU5CEU      │ BootStatusPolicy: 2            │
│                     │                              │       │                                │          │           │                      │ LastBootGood: true             │
│                     │                              │       │                                │          │           │                      │ LastBootId: 8                  │
│                     │                              │       │                                │          │           │                      │ LastShutdownGood: true         │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:20:46 │ + WMI registration           │ 1     │ Microsoft-Windows-Kernel-Gener │ 20       │ 2374      │ WIN-T131EJU5CEU      │ CountNew: 0                    │
│                     │                              │       │ al                             │          │           │                      │ CountOld: 0                    │
│                     │                              │       │                                │          │           │                      │ EnabledNew: true               │
│                     │                              │       │                                │          │           │                      │ UpdateReason: 0                │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
│ 2024-01-15 16:21:53 │ + WMI registration           │ 1     │ Microsoft-Windows-Kernel-Boot  │ 20       │ 2565      │ WIN-T131EJU5CEU      │ BootStatusPolicy: 2            │
│                     │                              │       │                                │          │           │                      │ LastBootGood: true             │
│                     │                              │       │                                │          │           │                      │ LastBootId: 9                  │
│                     │                              │       │                                │          │           │                      │ LastShutdownGood: true         │
├─────────────────────┼──────────────────────────────┼───────┼────────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┤
<SNIP>


C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe hunt -r rules/ ./Logs/ --mapping mappings/sigma-event-logs-all.yml --sigma ./sigma/rules/ --level medium --from "2024-01-01T00:00:00" --to "2024-12-31T00:00:00" > Test-Results.txt

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading detection rules from: rules/, ./sigma/rules/
[!] Loaded 1234 detection rules (195 not loaded)
[+] Loading forensic artefacts from: ./Logs/ (extensions: .evt, .evtx)
[+] Loaded 4 forensic artefacts (27.5 MB)
[+] Hunting: [========================================] 4/4 -
[+] 9 Detections found on 9 documents

[+] Group: Service Installation
┌─────────────────────┬────────────────────────────┬──────────┬───────────┬──────────────────────┬────────────────────────────────┬────────────────────────────────┬────────────────────┬────────────────────┬─────────────────┐
│      timestamp      │         detections         │ Event ID │ Record ID │       Computer       │          Service Name          │       Service File Name        │    Service Type    │ Service Start Type │ Service Account │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13654     │ Win-Srv-2022.lab     │ NGC Settings Manager           │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │                                │ GCx64\16170A0.00A\ccSetx64.sys │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13657     │ Win-Srv-2022.lab     │ Symantec Real Time Storage Pro │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │ tection (PEL) x64              │ GCx64\16170A0.00A\SRTSPX64.SYS │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13658     │ Win-Srv-2022.lab     │ Symantec Real Time Storage Pro │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │ tection x64                    │ GCx64\16170A0.00A\SRTSP64.SYS  │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13656     │ Win-Srv-2022.lab     │ Symantec Iron Driver           │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │                                │ GCx64\16170A0.00A\Ironx64.SYS  │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13660     │ Win-Srv-2022.lab     │ Symantec ELAM Driver           │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │                                │ GCx64\16170A0.00A\SymELAM.sys  │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13662     │ Win-Srv-2022.lab     │ NortonLifeLock Webcam Control  │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │ functional driver              │ GCx64\16170A0.00A\wpCtrlDrv.sy │                    │                    │                 │
│                     │                            │          │           │                      │                                │ s                              │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13661     │ Win-Srv-2022.lab     │ Symantec Network Security WFP  │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │ Driver                         │ GCx64\16170A0.00A\symnets.sys  │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13659     │ Win-Srv-2022.lab     │ Symantec Extended File Attribu │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │ tes (SI)                       │ GCx64\16170A0.00A\SYMEFASI64.S │                    │                    │                 │
│                     │                            │          │           │                      │                                │ YS                             │                    │                    │                 │
├─────────────────────┼────────────────────────────┼──────────┼───────────┼──────────────────────┼────────────────────────────────┼────────────────────────────────┼────────────────────┼────────────────────┼─────────────────┤
│ 2024-02-08 17:54:26 │ + Suspicious Paths Service │ 7045     │ 13664     │ Win-Srv-2022.lab     │ NortonLifeLock Split Tunneling │ \SystemRoot\System32\drivers\N │ kernel mode driver │ demand start       │                 │
│                     │ Installation               │          │           │                      │  WFP Callout driver            │ GCx64\16170A0.00A\nsvst.sys    │                    │                    │                 │
└─────────────────────┴────────────────────────────┴──────────┴───────────┴──────────────────────┴────────────────────────────────┴────────────────────────────────┴────────────────────┴────────────────────┴─────────────────┘


----------------------------------------------------------------------------------------------------------------------------------------------------------------------
Example 4 - Search with a specific keyword through all Windows event logs of a Windows computer using SIGMA & Chainsaw rules to detect potential malicious activities
----------------------------------------------------------------------------------------------------------------------------------------------------------------------

Step 1 - Extract the Windows event logs of the Windows machine that you want to audit (e.g. Win Server 2022) and then copy the log files on your DFIR computer/VM
-----------------------------------------------------------------------------------------------------------------------------------------------------------------

PS C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw\Logs2> ls

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2/15/2024   7:56 PM       12652544 Application.evtx
-a----         2/15/2024   7:55 PM        4263936 PowerShell.evtx
-a----         2/15/2024   7:54 PM       21041152 Security.evtx
-a----         2/15/2024   7:55 PM       21041152 System.evtx


Step 2 - Run Chainsaw on your DFIR computer/VM
-----------------------------------------------

C:\Users\analyst\Documents\Tools\17-DFIR\Chainsaw> chainsaw.exe search mimikatz -i ./Logs2/

 ██████╗██╗  ██╗ █████╗ ██╗███╗   ██╗███████╗ █████╗ ██╗    ██╗
██╔════╝██║  ██║██╔══██╗██║████╗  ██║██╔════╝██╔══██╗██║    ██║
██║     ███████║███████║██║██╔██╗ ██║███████╗███████║██║ █╗ ██║
██║     ██╔══██║██╔══██║██║██║╚██╗██║╚════██║██╔══██║██║███╗██║
╚██████╗██║  ██║██║  ██║██║██║ ╚████║███████║██║  ██║╚███╔███╔╝
 ╚═════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝ ╚══╝╚══╝
    By WithSecure Countercept (@FranticTyping, @AlexKornitzer)

[+] Loading forensic artefacts from: ./Logs2/
[+] Loaded 8 forensic files (133.8 MB)
[+] Searching forensic artefacts...
---
Event:
  EventData:
    Binary: null
    Data:
    - mimikatz.exe
    - 2.2.0.0
    - '63288e67'
    - ntdll.dll
    - 10.0.19041.2130
    - b5ced1c6
    - c0000374
    - 00000000000ff6a9
    - 2dbc
    - 01d967a0ff103b7c
    - C:\temp\mimikatz_trunk_last\x64\mimikatz.exe
    - C:\Windows\SYSTEM32\ntdll.dll
    - c75d4409-2bc2-4017-bd3a-2a648ed07d5b
    - ''
    - ''
  System:
    Channel: Application
    Computer: Laptop01.lab.local 
    Correlation: null
    EventID: 1000
    EventID_attributes:
      Qualifiers: 0
    EventRecordID: 13828
    Execution_attributes:
      ProcessID: 0
      ThreadID: 0
    Keywords: '0x80000000000000'
    Level: 2
    Opcode: 0
    Provider_attributes:
      Name: Application Error
    Security: null
    Task: 100
    TimeCreated_attributes:
      SystemTime: 2023-04-05T09:28:35.682625Z
    Version: 0
Event_attributes:
  xmlns: http://schemas.microsoft.com/win/2004/08/events/event

---
<SNIP>

